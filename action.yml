name: 'FHIR CapabilityStatement Expander'
description: 'Expands FHIR CapabilityStatements by recursively resolving imports and extracts all referenced resources'
author: 'Patrick Werner'

branding:
  icon: 'layers'
  color: 'blue'

inputs:
  input_directory:
    description: 'Path to input directory with FHIR JSON files'
    required: true
    default: './input'
  output_directory:
    description: 'Path to output directory for expanded resources'
    required: true
    default: './output'
  capability_statement_url:
    description: 'Canonical URL of the CapabilityStatement to expand'
    required: true
  verbose:
    description: 'Enable verbose logging'
    required: false
    default: 'false'
  python_version:
    description: 'Python version for execution'
    required: false
    default: '3.11'

outputs:
  expanded_files_count:
    description: 'Number of created expanded files'
    value: ${{ steps.expand.outputs.files_count }}
  output_directory:
    description: 'Path to output directory with expanded resources'
    value: ${{ inputs.output_directory }}
  expanded_capability_statement:
    description: 'Filename of the expanded CapabilityStatement'
    value: ${{ steps.expand.outputs.expanded_file }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version }}
               
    - name: Validate Input Directory
      shell: bash
      run: |
        if [ ! -d "${{ inputs.input_directory }}" ]; then
          echo "âŒ Input directory not found: ${{ inputs.input_directory }}"
          exit 1
        fi
        
        json_files=$(find "${{ inputs.input_directory }}" -name "*.json" | wc -l)
        echo "âœ… Input directory found with $json_files JSON files"
        
        if [ "$json_files" -eq 0 ]; then
          echo "âš ï¸  Warning: No JSON files found in input directory"
        fi
        
    - name: Create Output Directory
      shell: bash
      run: |
        mkdir -p "${{ inputs.output_directory }}"
        echo "ðŸ“ Output directory created: ${{ inputs.output_directory }}"
        
    - name: Run FHIR CapabilityStatement Expander
      id: expand
      shell: bash
      run: |
        echo "ðŸš€ Starting FHIR CapabilityStatement Expander..."
        
        # Determine verbose flag - auto-enable when GitHub Actions debug logging is active
        VERBOSE_FLAG=""
        if [ "${{ inputs.verbose }}" = "true" ] || [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
          VERBOSE_FLAG="--verbose"
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            echo "ðŸ” Auto-enabled verbose logging (GitHub Actions debug mode detected)"
          fi
        fi
        
        # Run the expander
        if [ "${{ inputs.verbose }}" = "true" ] || [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
          echo "ðŸ” Debug: Action path: ${{ github.action_path }}"
          echo "ðŸ” Debug: Working directory: $(pwd)"
          echo "ðŸ” Debug: Action context - Repository: ${{ github.repository }}"
          echo "ðŸ” Debug: Action context - Ref: ${{ github.ref }}"
          echo "ðŸ” Debug: Looking for script at: ${{ github.action_path }}/capability_statement_expander.py"
          
          # Check if entire actions directory structure exists
          echo "ðŸ” Debug: Actions root directory:"
          ls -la /home/runner/work/_actions/ 2>/dev/null || echo "Actions root not accessible"
          
          # Check if Gefyra directory exists
          echo "ðŸ” Debug: Gefyra directory:"
          ls -la /home/runner/work/_actions/Gefyra/ 2>/dev/null || echo "Gefyra directory not found"
          
          # Check if repository directory exists
          echo "ðŸ” Debug: Repository directory:"
          ls -la /home/runner/work/_actions/Gefyra/capabilityStatement-expander/ 2>/dev/null || echo "Repository directory not found"
          
          # Check parent directories
          echo "ðŸ” Debug: Parent directory structure:"
          ls -la "$(dirname "${{ github.action_path }}")" 2>/dev/null || echo "Parent not accessible"
          
          echo "ðŸ” Debug: Contents of action path:"
          ls -la "${{ github.action_path }}/" || echo "Action path not accessible"
          
          # Try to find the script anywhere - universal approach
          echo "ðŸ” Debug: Searching for Python script universally:"
          find / -name "capability_statement_expander.py" -type f 2>/dev/null | head -5 || echo "Python script not found anywhere"
          
          echo "ðŸ” Debug: Searching for any Python files in system:"
          find / -name "*.py" -path "*action*" -type f 2>/dev/null | head -10 || echo "No action Python files found"
          
          echo "ðŸ” Debug: Current working directory content:"
          ls -la .
          
          echo "ðŸ” Debug: Environment variables:"
          echo "GITHUB_ACTION_PATH: ${GITHUB_ACTION_PATH:-not set}"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-not set}"
          
          # Search for any directories with similar names
          echo "ðŸ” Debug: Searching for similar directory names:"
          find /home/runner/work/_actions -type d -name "*capability*" 2>/dev/null || echo "No capability directories found"
          find /home/runner/work/_actions -type d -name "*Gefyra*" 2>/dev/null || echo "No Gefyra directories found"
        fi
        
        # Check if script exists and provide fallback
        if [ -f "${{ github.action_path }}/capability_statement_expander.py" ]; then
          echo "âœ… Script found, executing..."
          python "${{ github.action_path }}/capability_statement_expander.py" \
            "${{ inputs.input_directory }}" \
            "${{ inputs.output_directory }}" \
            "${{ inputs.capability_statement_url }}" \
            $VERBOSE_FLAG
        else
          echo "âŒ Script not found at expected location"
          echo "ðŸ” Trying alternative locations..."
          find /home/runner/work/_actions -name "capability_statement_expander.py" 2>/dev/null || echo "Script not found anywhere"
          exit 1
        fi
        
        # Count generated files
        files_count=$(find "${{ inputs.output_directory }}" -name "*.json" | wc -l)
        echo "files_count=$files_count" >> $GITHUB_OUTPUT
        
        # Find expanded CapabilityStatement file
        expanded_file=$(find "${{ inputs.output_directory }}" -name "*expanded.json" | head -1 | xargs basename 2>/dev/null || echo "")
        echo "expanded_file=$expanded_file" >> $GITHUB_OUTPUT
        
        echo "âœ… Successfully generated $files_count files"
        
    - name: List Generated Files
      shell: bash
      run: |
        echo "ðŸ“„ Generated FHIR Resources:"
        echo "================================"
        
        total_files=0
        for file in "${{ inputs.output_directory }}"/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
            echo "  ðŸ“‹ $filename (${size} bytes)"
            total_files=$((total_files + 1))
          fi
        done
        
        echo "================================"
        echo "ðŸ“Š Total $total_files JSON files created"
        
        # Show basic info about expanded CapabilityStatement (if available)
        expanded_file=$(find "${{ inputs.output_directory }}" -name "*expanded.json" | head -1)
        if [ -f "$expanded_file" ]; then
          echo ""
          echo "ðŸ” Expanded CapabilityStatement created:"
          echo "ðŸ“‹ File: $(basename "$expanded_file")"
          echo "ï¿½ Size: $(stat -f%z "$expanded_file" 2>/dev/null || stat -c%s "$expanded_file" 2>/dev/null || echo "unknown") bytes"
        fi