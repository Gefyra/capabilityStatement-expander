name: Release Action

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Triggers only on full semantic version tags like v0.7.4, v1.2.3, etc.
      # Excludes major version tags like v0, v1 to prevent accidental version resets

jobs:
  test:
    uses: ./.github/workflows/ci.yml
  
  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract version from tag
      id: version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=${TAG#v}" >> $GITHUB_OUTPUT
    
    - name: Update version in Python script
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" capability_statement_expander.py
        echo "âœ… Updated __version__ to $VERSION in capability_statement_expander.py"
        
    - name: Commit version update and update tags to point to the same commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add capability_statement_expander.py
        if git diff-index --quiet HEAD; then
          echo "â„¹ï¸ Version already correct - no changes to commit"
        else
          git commit -m "chore: update version to ${{ steps.version.outputs.version }}"
          git push origin HEAD:main
        fi
        
        # Update both version tag and major tag to point to the current commit (always, not just on commit)
        NEW_COMMIT=$(git rev-parse HEAD)
        MAJOR_VERSION=$(echo ${{ steps.version.outputs.tag }} | cut -d. -f1)
        
        echo "ğŸ“Œ Updating tags to point to commit: $NEW_COMMIT"
        git tag -f ${{ steps.version.outputs.tag }} $NEW_COMMIT
        git tag -f $MAJOR_VERSION $NEW_COMMIT
        
        echo "ğŸ”„ Pushing updated tags..."
        git push --force origin refs/tags/${{ steps.version.outputs.tag }}
        git push --force origin refs/tags/$MAJOR_VERSION
        
        echo "âœ… Both tags now point to the same commit: $NEW_COMMIT"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: FHIR CapabilityStatement Expander ${{ steps.version.outputs.tag }}
        body: |
          ## ğŸš€ FHIR CapabilityStatement Expander ${{ steps.version.outputs.tag }}
          
          ### âœ¨ Features
          - ğŸ”„ Recursive import resolution for CapabilityStatements
          - ğŸ“‹ Smart example detection via meta.profile references
          - ğŸ§© Complete resource extraction (profiles, valuesets, examples)
          - âš¡ Ready-to-use GitHub Action
          
          ### ğŸ“– Usage
          ```yaml
          - name: Expand CapabilityStatement
            uses: Gefyra/capabilityStatement-expander@${{ steps.version.outputs.tag }}
            with:
              input_directory: './fhir-resources'
              output_directory: './expanded-resources'
              capability_statement_url: 'https://example.org/fhir/CapabilityStatement/MyCS'
          ```
          
          ### ğŸ“¦ What's Included
          - Complete FHIR R4 compatibility
          - Automatic dependency resolution
          - Example detection via meta.profile matching
          - Comprehensive logging and error handling
          
          For full documentation, see the [README](https://github.com/Gefyra/capabilityStatement-expander/blob/main/README.md).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify success
      run: |
        echo "ğŸ‰ Successfully released ${{ steps.version.outputs.tag }}"
        echo "ğŸ“¦ Users can now use: Gefyra/capabilityStatement-expander@${{ steps.version.outputs.tag }}"
        echo "ğŸ“¦ Or use major version: Gefyra/capabilityStatement-expander@$(echo ${{ steps.version.outputs.tag }} | cut -d. -f1)"